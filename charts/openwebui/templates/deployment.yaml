apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ .Release.Name }}
  namespace: {{ .Release.Namespace }}
  labels:
    app.kubernetes.io/name: openwebui
    app.kubernetes.io/instance: {{ .Release.Name }}
    app.kubernetes.io/version: {{ .Chart.AppVersion }}
    app.kubernetes.io/managed-by: {{ .Release.Service }}
spec:
  replicas: {{ .Values.replicaCount }}
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0
  selector:
    matchLabels:
      app.kubernetes.io/name: openwebui
      app.kubernetes.io/instance: {{ .Release.Name }}
  template:
    metadata:
      labels:
        app.kubernetes.io/name: openwebui
        app.kubernetes.io/instance: {{ .Release.Name }}
    spec:
      serviceAccountName: {{ .Values.serviceAccount.name }}
      securityContext:
        {{- toYaml .Values.podSecurityContext | nindent 8 }}
      {{- if .Values.nodeSelector }}
      nodeSelector:
        {{- toYaml .Values.nodeSelector | nindent 8 }}
      {{- end }}
      {{- if .Values.tolerations }}
      tolerations:
        {{- toYaml .Values.tolerations | nindent 8 }}
      {{- end }}
      initContainers:
        # Fix permissions on application files (OpenWebUI image has root-owned files)
        - name: fix-permissions
          image: "{{ .Values.image.repository }}:{{ .Values.image.tag }}"
          command:
            - sh
            - -c
            - |
              echo "Fixing permissions..."
              chown -R 1000:1000 /app/backend/open_webui 2>/dev/null || true
              echo "✓ Permissions fixed"
          securityContext:
            runAsUser: 0
      {{- if and .Values.rag.enabled .Values.rag.preloadModel }}
        # Pre-download embedding model for RAG (requires internet access during init)
        - name: download-embedding-model
          image: localhost:5001/python:3.11-slim
          command:
            - /bin/sh
            - -c
            - |
              # Set cache directory
              cache_dir="/app/cache"
              model_name="{{ .Values.rag.embeddingModel }}"
              # HuggingFace uses format: models--org--model-name (replace / with --)
              hf_model_path="$cache_dir/models--$(echo $model_name | sed 's/\//--/g')"
              
              # Check if model already exists (HuggingFace cache format)
              if [ -d "$hf_model_path" ] && [ "$(ls -A $hf_model_path 2>/dev/null)" ]; then
                echo "✓ Model already cached at $hf_model_path"
                echo "✓ Skipping download - using cached model"
                exit 0
              fi
              
              echo "Installing dependencies (this may take a few minutes)..."
              pip install sentence-transformers huggingface-hub --progress-bar on
              
              echo "Downloading embedding model: $model_name"
              python3 << 'EOF'
              from sentence_transformers import SentenceTransformer
              import os
              
              # Set cache directory to shared volume
              cache_dir = "/app/cache"
              os.makedirs(cache_dir, exist_ok=True)
              os.environ['SENTENCE_TRANSFORMERS_HOME'] = cache_dir
              os.environ['HF_HOME'] = cache_dir
              
              print("Downloading model from HuggingFace...")
              # Download model - library shows its own progress
              model = SentenceTransformer("{{ .Values.rag.embeddingModel }}", cache_folder=cache_dir)
              print(f"✓ Model downloaded successfully to {cache_dir}")
              EOF
              
              echo "✓ Embedding model ready!"
          volumeMounts:
            - name: data
              mountPath: /app/backend/data
          securityContext:
            runAsNonRoot: false  # Need root to install pip packages
            runAsUser: 0
      {{- end}}
      containers:
        - name: openwebui
          image: "{{ .Values.image.repository }}:{{ .Values.image.tag }}"
          imagePullPolicy: {{ .Values.image.pullPolicy }}
          ports:
            - name: http
              containerPort: {{ .Values.service.targetPort }}
              protocol: TCP
          envFrom:
            - configMapRef:
                name: {{ .Release.Name }}-config
          env:
            - name: DATA_DIR
              value: {{ .Values.persistence.mountPath }}
            - name: WEBUI_SECRET_KEY
              valueFrom:
                secretKeyRef:
                  name: {{ include "openwebui.fullname" . }}-secret
                  key: WEBUI_SECRET_KEY
            {{- if and .Values.rag.enabled .Values.rag.preloadModel }}
            # Use cached embedding models from init container
            - name: SENTENCE_TRANSFORMERS_HOME
              value: /app/cache
            - name: HF_HOME
              value: /app/cache
            - name: HF_HUB_OFFLINE
              value: "1"  # Force offline mode - use cached models only
            {{- end }}
          {{- if .Values.env }}
            {{- toYaml .Values.env | nindent 12 }}
          {{- end }}
          {{- if .Values.livenessProbe.enabled }}
          livenessProbe:
            httpGet:
              path: {{ .Values.livenessProbe.httpGet.path }}
              port: {{ .Values.livenessProbe.httpGet.port }}
            initialDelaySeconds: {{ .Values.livenessProbe.initialDelaySeconds }}
            periodSeconds: {{ .Values.livenessProbe.periodSeconds }}
            timeoutSeconds: {{ .Values.livenessProbe.timeoutSeconds }}
            failureThreshold: {{ .Values.livenessProbe.failureThreshold }}
          {{- end }}
          {{- if .Values.readinessProbe.enabled }}
          readinessProbe:
            httpGet:
              path: {{ .Values.readinessProbe.httpGet.path }}
              port: {{ .Values.readinessProbe.httpGet.port }}
            initialDelaySeconds: {{ .Values.readinessProbe.initialDelaySeconds }}
            periodSeconds: {{ .Values.readinessProbe.periodSeconds }}
            timeoutSeconds: {{ .Values.readinessProbe.timeoutSeconds }}
            failureThreshold: {{ .Values.readinessProbe.failureThreshold }}
          {{- end }}
          resources:
            {{- toYaml .Values.resources | nindent 12 }}
          volumeMounts:
            - name: data
              mountPath: {{ .Values.persistence.mountPath }}
          securityContext:
            {{- toYaml .Values.securityContext | nindent 12 }}
      volumes:
        - name: data
          {{- if .Values.persistence.enabled }}
          persistentVolumeClaim:
            claimName: {{ .Release.Name }}-data
          {{- else }}
          emptyDir: {}
          {{- end }}
